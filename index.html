<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LANZA BULLS - 拽专 转</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #0d6efd;
            --text-color: #e0e0e0;
            --text-secondary: #aaaaaa;
            --green: #198754;
            --red: #dc3545;
            --buy: #26a69a;
            --sell: #ef5350;
            --hold: #ffca28;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        /* --- 拽  砖 --- */
        .logo-placeholder {
            width: 50px; height: 50px;
            background-color: var(--surface-color); /* 爪注 专拽注  */
            border: 2px dashed var(--primary-color);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); font-size: 0.8em; text-align: center;
            border-radius: 5px;
            /*  砖  拽抓 SVG, 砖 转  拽 -div */
            /*  砖  转, 砖转砖 - <img src="link/to/your/logo.png" alt="LANZA BULLS Logo" style="width: 50px; height: 50px;"> */
        }
        .header h1 { color: var(--text-color); font-size: 2.5em; margin: 0; font-weight: bold; }
        h2, h3 { color: var(--primary-color); }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        input[type="text"] { flex-grow: 1; padding: 12px; font-size: 1.1em; background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--text-secondary); border-radius: 6px; }
        button { padding: 12px 20px; font-size: 1.1em; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0b5ed7; }
        #homepage-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .mover-card { background-color: var(--surface-color); border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto; }
        .mover-card h3 { margin-top: 0; }
        .mover-list { list-style: none; padding: 0; }
        .mover-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; font-size: 1.1em; }
        .mover-list li:last-child { border: none; }
        .mover-list .symbol { font-weight: bold; }
        .mover-list .change-gainer { color: var(--green); }
        .mover-list .change-loser { color: var(--red); }
        .mover-list .volume { color: var(--text-secondary); font-size: 0.9em; }
        #stock-details-view { display: none; }
        .stock-header { border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; }
        .stock-header h1 { margin: 0; font-size: 2.5em; }
        .stock-header .sub-header { font-size: 1.2em; color: var(--text-secondary); }
        .price { font-size: 2.8em; font-weight: bold; margin: 10px 0; }
        .change { font-size: 1.5em; }
        #chart-container { width: 100%; height: 400px; margin: 30px 0; }
        .tabs-nav { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab-button { padding: 15px 25px; cursor: pointer; font-size: 1.1em; background: none; border: none; color: var(--text-secondary); border-bottom: 3px solid transparent; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; background-color: var(--surface-color); padding: 20px; border-radius: 8px; }
        .tab-content.active { display: block; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; /* More columns for more data */ }
        .data-point { background: var(--bg-color); padding: 15px; border-radius: 6px; }
        .data-point .label { font-size: 0.9em; color: var(--text-secondary); display: block; margin-bottom: 5px; }
        .data-point .value { font-size: 1.2em; font-weight: bold; /* Slightly smaller value font */ }
        .news-list { list-style: none; padding: 0; }
        .news-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .news-item a { color: var(--primary-color); text-decoration: none; font-size: 1.2em; }
        .news-item a:hover { text-decoration: underline; }
        .news-item p { margin: 5px 0; color: var(--text-secondary); }
        #analyst-chart-container { max-width: 400px; margin: 20px auto; }
        #loader { text-align: center; font-size: 1.5em; padding: 50px; display: none; }
        /* Helper classes for sentiment color */
        .sentiment-positive { color: var(--green); }
        .sentiment-negative { color: var(--red); }
        .sentiment-neutral { color: var(--text-secondary); }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="logo-placeholder"></div>
            <h1>LANZA BULLS</h1>
        </div>

        <div class="search-box">
            <input type="text" id="stockSymbol" placeholder="拽 住  (砖: AAPL)">
            <button onclick="searchStock()">驻砖</button>
        </div>

        <div id="loader">注 转... </div>

        <div id="homepage-view">
            <div class="mover-card">
                <h3>转 注转 (Top Gainers)</h3>
                <ul class="mover-list" id="top-gainers-list"></ul>
            </div>
            <div class="mover-card">
                <h3>转 驻注转 (Most Active)</h3>
                <ul class="mover-list" id="most-active-list"></ul>
            </div>
        </div>

        <div id="stock-details-view">

            <div class="stock-header">
                <h1 id="companyName"></h1>
                <span class="sub-header" id="companyTicker"></span>
                <div class="price" id="stockPrice"></div>
                <div class="change" id="stockChange"></div>
            </div>

            <div id="chart-container"></div>
            <div id="flags" style="margin-bottom: 20px;"></div>

            <div class="tabs-nav">
                <button class="tab-button active" onclick="showTab('overview')">住拽专 </button>
                <button class="tab-button" onclick="showTab('financials')">转 住驻</button>
                <button class="tab-button" onclick="showTab('sentiment')">砖转 住</button>
                <button class="tab-button" onclick="showTab('analysts')">爪转 住</button>
            </div>

            <div id="tabs-content">
                <div id="overview" class="tab-content active">
                    <h3>转 专</h3>
                    <p id="companyDescription"></p>
                    <hr style="border-color: #444;">
                    <h3> 驻转</h3>
                    <div class="data-grid">
                        <div class="data-point"><span class="label">砖 砖拽</span><span class="value" id="marketCap"></span></div>
                        <div class="data-point"><span class="label">驻 专 (P/E)</span><span class="value" id="peRatio"></span></div>
                        <div class="data-point"><span class="label">专  (EPS)</span><span class="value" id="eps"></span></div>
                        <div class="data-point"><span class="label">驻 专 注转</span><span class="value" id="forwardPE"></span></div>
                        <div class="data-point"><span class="label">住 专/专转 (P/S)</span><span class="value" id="psRatio"></span></div>
                        <div class="data-point"><span class="label">转砖转 </span><span class="value" id="dividendYield"></span></div>
                        <div class="data-point"><span class="label"> (尾)</span><span class="value" id="beta"></span></div>
                        <div class="data-point"><span class="label"> 52 砖注转</span><span class="value" id="weekRange52"></span></div>
                        <div class="data-point"><span class="label">爪注 注 50 </span><span class="value" id="ma50"></span></div>
                        <div class="data-point"><span class="label">爪注 注 200 </span><span class="value" id="ma200"></span></div>
                        <div class="data-point"><span class="label"> </span><span class="value" id="dayRange"></span></div>
                        <div class="data-point"><span class="label"></span><span class="value" id="volume"></span></div>
                    </div>
                </div>

                <div id="financials" class="tab-content">
                    <h3> 专 驻住 (专注 专)</h3>
                    <p> 住 -USD.</p>
                    <div class="data-grid" id="income-statement-grid"></div>
                </div>

                <div id="sentiment" class="tab-content">
                    <h3>砖转 住</h3>
                     <div class="data-point" style="margin-bottom: 20px;">
                        <span class="label">住 爪注 砖转 专转</span>
                        <span class="value" id="avgSentiment">N/A</span>
                    </div>
                    <ul class="news-list" id="news-list"></ul>
                </div>

                <div id="analysts" class="tab-content">
                    <h3>拽爪住 住</h3>
                    <p id="analyst-summary"></p>
                    <div id="analyst-chart-container">
                        <canvas id="analystChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 拽 -JavaScript ---

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! : 祝 转转 砖专转 砖 -Render !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const API_BASE_URL = "https://lanza-bulls-backend.onrender.com"; // <--  转转 砖

        let mainChart = null;
        let analystChart = null;

        const financialLabels = {
            "fiscalDateEnding": "转专 住 专注", "totalRevenue": "住\" 住转",
            "costOfRevenue": "注转 住转", "grossProfit": "专 ",
            "operatingIncome": "专 转驻注", "netIncome": "专 拽", "ebitda": "EBITDA"
        };

        document.addEventListener('DOMContentLoaded', fetchMarketMovers);

        async function fetchMarketMovers() {
            showLoader(true);
            try {
                const response = await fetch(`${API_BASE_URL}/market-movers`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderList('top-gainers-list', data.topGainers, stock => `<span class="change-gainer">+${stock.change_percentage}</span>`);
                renderList('most-active-list', data.mostActive, stock => `<span class="volume">${Number(stock.volume).toLocaleString()}</span>`);
            } catch (error) {
                console.error("Error fetching market movers:", error);
                displayError('homepage-view', '砖 注转 转 砖拽.');
            } finally {
                showLoader(false);
            }
        }

        function renderList(listId, items, valueRenderer) {
             const listElement = document.getElementById(listId);
             listElement.innerHTML = ''; // Clear previous items
             if (!items || items.length === 0) {
                 listElement.innerHTML = '<li> 爪 转.</li>';
                 return;
             }
             items.forEach(stock => {
                 listElement.innerHTML += `
                     <li>
                         <span class="symbol">${stock.ticker}</span>
                         ${valueRenderer(stock)}
                     </li>
                 `;
             });
        }


        async function searchStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase().trim();
            if (!symbol) { alert(" 住 住 "); return; }

            showLoader(true, true); // Show loader, hide previous views
            try {
                const response = await fetch(`${API_BASE_URL}/stock-data?symbol=${symbol}`);
                 if (!response.ok) {
                     // Try to get error message from server response if available
                     let errorMsg = `HTTP error! status: ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorMsg = errorData.error || errorMsg;
                     } catch (e) { /* Ignore if response is not JSON */ }
                     throw new Error(errorMsg);
                 }
                const data = await response.json();

                if (!data.overview || data.overview.Note || (data.overview && Object.keys(data.overview).length === 0 && data.quote && data.quote.d === undefined)) {
                    throw new Error(" 爪 注 注专 住 砖住,  砖专转 转 API.");
                }

                displayStockData(data);
                document.getElementById('stock-details-view').style.display = 'block';

            } catch (error) {
                console.error("Error fetching stock data:", error);
                alert(`砖: ${error.message}`);
                document.getElementById('homepage-view').style.display = 'grid'; // Show homepage on error
            } finally {
                showLoader(false);
            }
        }

        function displayStockData(data) {
            // --- Header & Price ---
            setText('companyName', data.overview.Name);
            setText('companyTicker', data.overview.Symbol);
            const price = data.quote.c?.toFixed(2) || 'N/A';
            const change = data.quote.d?.toFixed(2) || 'N/A';
            const changePercent = data.quote.dp?.toFixed(2) || 'N/A';
            const changeColor = data.quote.d >= 0 ? 'var(--green)' : 'var(--red)';
            setText('stockPrice', `$${price}`);
            setText('stockChange', `${change} (${changePercent}%)`, changeColor);

            // --- Flags ---
            const flagsContainer = document.getElementById('flags');
            flagsContainer.innerHTML = '';
            if (data.flags.isUnusualVolume) {
                flagsContainer.innerHTML += `<span style="background: var(--primary-color); padding: 5px 10px; border-radius: 5px; margin-left: 5px;">  专</span>`;
            }
             // Add more flags here if needed

            // --- Overview Tab ---
            setText('companyDescription', data.overview.Description);
            setText('marketCap', formatNumber(data.overview.MarketCapitalization));
            setText('peRatio', data.overview.PERatio);
            setText('eps', data.overview.EPS);
            setText('forwardPE', data.overview.ForwardPE);
            setText('psRatio', data.overview.PriceToSalesRatioTTM);
            setText('dividendYield', formatPercent(data.overview.DividendYield));
            setText('beta', data.overview.Beta);
            setText('weekRange52', `$${data.overview['52WeekLow']} - $${data.overview['52WeekHigh']}`);
            setText('ma50', data.overview['50DayMovingAverage']);
            setText('ma200', data.overview['200DayMovingAverage']);
            setText('dayRange', `$${data.quote.l?.toFixed(2)} - $${data.quote.h?.toFixed(2)}`);
            setText('volume', formatNumber(data.quote.v));

            // --- Financials Tab ---
            renderFinancials(data.incomeStatement);

            // --- Sentiment Tab ---
            renderNews(data.news);
            renderSentiment(data.avgNewsSentiment);

            // --- Analysts Tab ---
            renderAnalystData(data.recommendations);

            // --- Charts ---
            renderMainChart(data.chartData);

            showTab('overview'); // Reset to first tab
        }

        // --- Helper functions ---
        function setText(id, value, color = null) {
            const element = document.getElementById(id);
            if (element) {
                element.innerText = (value !== null && value !== undefined && value !== 'None' && value !== '-') ? value : 'N/A';
                if (color) element.style.color = color;
                else element.style.color = ''; // Reset color if not specified
            }
        }
        function formatNumber(numStr) {
             const num = Number(numStr);
             return !isNaN(num) ? num.toLocaleString() : 'N/A';
        }
        function formatPercent(numStr) {
             const num = Number(numStr);
             return !isNaN(num) ? `${(num * 100).toFixed(2)}%` : 'N/A';
        }
         function showLoader(show, hideViews = false) {
             document.getElementById('loader').style.display = show ? 'block' : 'none';
             if (hideViews) {
                 document.getElementById('homepage-view').style.display = 'none';
                 document.getElementById('stock-details-view').style.display = 'none';
             }
         }
         function displayError(viewId, message) {
             const viewElement = document.getElementById(viewId);
             if (viewElement) viewElement.innerHTML = `<p style="color: var(--red);">${message}</p>`;
         }

        // --- Rendering functions ---
        function renderFinancials(incomeReport) {
            const incomeGrid = document.getElementById('income-statement-grid');
            incomeGrid.innerHTML = '';
            if (incomeReport && Object.keys(incomeReport).length > 0 && incomeReport.fiscalDateEnding !== undefined) {
                for (const key in financialLabels) {
                    if (incomeReport[key] && incomeReport[key] !== 'None') {
                        const value = Number(incomeReport[key]) ? Number(incomeReport[key]).toLocaleString() : incomeReport[key];
                        incomeGrid.innerHTML += `
                            <div class="data-point">
                                <span class="label">${financialLabels[key]}</span>
                                <span class="value">${value}</span>
                            </div>`;
                    }
                }
            } else {
                 incomeGrid.innerHTML = '<p> 爪 转 住驻 注.</p>';
            }
        }

        function renderNews(newsItems) {
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '';
            if (newsItems && newsItems.length > 0) {
                newsItems.slice(0, 15).forEach(item => {
                    newsList.innerHTML += `
                        <li class="news-item">
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                            <p>${item.summary}</p>
                            <small style="color: var(--text-secondary);">${item.source} - ${new Date(item.time_published).toLocaleString('he-IL')}</small>
                        </li>`;
                });
            } else {
                newsList.innerHTML = '<p> 爪 砖转 专转.</p>';
            }
        }
        function renderSentiment(avgSentiment) {
             const sentimentElement = document.getElementById('avgSentiment');
             if (avgSentiment !== null) {
                 let sentimentText = '专';
                 let sentimentClass = 'sentiment-neutral';
                 const score = parseFloat(avgSentiment);
                 if (score >= 0.15) { sentimentText = ''; sentimentClass = 'sentiment-positive'; }
                 else if (score <= -0.15) { sentimentText = '砖'; sentimentClass = 'sentiment-negative'; }
                 sentimentElement.innerText = `${sentimentText} (${avgSentiment})`;
                 sentimentElement.className = `value ${sentimentClass}`; // Apply class
             } else {
                 sentimentElement.innerText = 'N/A';
                 sentimentElement.className = 'value'; // Reset class
             }
        }

        function renderAnalystData(rec) {
            const summaryElement = document.getElementById('analyst-summary');
            const chartContainer = document.getElementById('analyst-chart-container');
            if (rec && rec.period && (rec.strongBuy || rec.buy || rec.hold || rec.sell || rec.strongSell)) {
                 const totalAnalysts = (rec.strongBuy || 0) + (rec.buy || 0) + (rec.hold || 0) + (rec.sell || 0) + (rec.strongSell || 0);
                 summaryElement.innerText = `住住 注 ${totalAnalysts} 住 (注 专: ${rec.period})`;
                 chartContainer.style.display = 'block';
                 renderAnalystChart(rec);
            } else {
                summaryElement.innerText = ' 转 住 .';
                chartContainer.style.display = 'none'; // Hide chart if no data
                if (analystChart) { analystChart.destroy(); analystChart = null; }
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName)?.classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`)?.classList.add('active');
        }

        function renderMainChart(data) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '';
            if (mainChart) { mainChart.remove(); mainChart = null; }

            if (!data || !data.c || data.s === 'no_data' || data.c.length === 0) {
                chartContainer.innerText = " 转 专祝 .";
                return;
            }

            mainChart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth, height: 400,
                layout: { backgroundColor: 'var(--surface-color)', textColor: 'var(--text-color)' },
                grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
                timeScale: { borderColor: '#777', timeVisible: true, secondsVisible: false }, // Show dates clearly
                 rightPriceScale: { borderColor: '#777' },
                 crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });

            const candleSeries = mainChart.addCandlestickSeries({
                upColor: 'var(--green)', downColor: 'var(--red)', borderDownColor: 'var(--red)',
                borderUpColor: 'var(--green)', wickDownColor: 'var(--red)', wickUpColor: 'var(--green)',
            });

            const chartData = data.t.map((time, index) => ({
                time: time, open: data.o[index], high: data.h[index],
                low: data.l[index], close: data.c[index],
            }));

            candleSeries.setData(chartData);
            mainChart.timeScale().fitContent();
        }

        function renderAnalystChart(data) {
            const ctx = document.getElementById('analystChart').getContext('2d');
            if (analystChart) analystChart.destroy();

            analystChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['拽 拽', '拽', '拽', '专', '专 拽'],
                    datasets: [{
                        label: '住驻专 爪转',
                        data: [data.strongBuy||0, data.buy||0, data.hold||0, data.sell||0, data.strongSell||0], // Use ||0 as fallback
                        backgroundColor: ['var(--green)', 'rgba(40, 167, 69, 0.7)', 'var(--hold)', 'rgba(220, 53, 69, 0.7)', 'var(--sell)'],
                        borderColor: 'var(--surface-color)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars can look better for this
                    responsive: true,
                     maintainAspectRatio: false, // Allow chart to fill container
                    plugins: {
                         legend: { display: false },
                         tooltip: {
                             callbacks: { label: (context) => `${context.raw} 爪转` }
                         }
                    },
                    scales: {
                        y: { ticks: { color: 'var(--text-secondary)' }, grid: { display: false } }, // Cleaner y-axis
                        x: {
                            beginAtZero: true,
                            ticks: { color: 'var(--text-secondary)', stepSize: 1 }, // Ensure whole numbers for counts
                            grid: { color: '#444' }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>